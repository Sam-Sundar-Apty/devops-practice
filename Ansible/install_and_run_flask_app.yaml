---
- name: Copy and Install MySQL, Python
  hosts: all
  become: yes
  vars:
     run_group: sam
     run_user: sam
     db_name: employee_db
     db_user: db_user
     db_password: Passw0rd

  tasks:
   - name: "Copy test file"
      copy:
        src: "/home/sam/scripts/ansible_test.txt"
        dest: "/root/scripts/"
        owner: "{{ run_user }}"
        group: "{{ run_group }}"
        remote_src: yes
        mode: 0755
        backup: yes
        
   - name: Install dependencies
      apt: name={{ item }} state=present
      with_items:
       - python
       - python-setuptools
       - python-dev
       - build-essential
       - python-pip
       - python-mysqldb
       
    - name: "Replace INFO to DEBUG"
      become: yes
      become_user: "root"
      become_user: "sam"
      replace: 
        path: /home/sam/hyperic-hq-agent/conf/agent.properties
        regexp: 'agent.logLevel=INFO'
        replace: 'agent.logLevel=DEBUG'
        backup: yes   
   
   - name: Install MySQL database
      apt:
        name: "{{ item }}"
        state:  present
      with_items:
       - mysql-server
       - mysql-client

    - name: Start Mysql Service
      service:
        name: mysql
        state: started
        enabled: yes
        

    - name: Create Application Database
      mysql_db: name={{ db_name }} state=present

    - name: Create Application DB User
      mysql_user: name={{ db_user }} password={{ db_password }} priv='*.*:ALL' host='%' state='present'

      
    - name: Install Python Flask dependencies
      pip:
        name: '{{ item }}'
        state: present
      with_items:
       - flask
       - flask-mysql

    - name: Copy web-server code
      copy: src=app.py dest=/opt/app.py

    - name: Start web-application
      shell: FLASK_APP=/opt/app.py nohup flask run --host=0.0.0.0 &      
   